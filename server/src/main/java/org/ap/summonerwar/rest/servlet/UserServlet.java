package org.ap.summonerwar.rest.servlet;

import javax.ws.rs.*;
import javax.ws.rs.core.*;
import org.bson.Document;
import javax.ws.rs.core.Response.*;
import org.ap.web.storage.Mongo;
import org.ap.web.rest.servlet.APServletBase;
import org.ap.summonerwar.bean.UserBean;
import javax.annotation.security.RolesAllowed;
import java.util.ArrayList;
import java.util.List;
import com.mongodb.client.FindIterable;
import org.ap.web.internal.UUIDGenerator;
import com.mongodb.MongoWriteException;
import org.ap.summonerwar.storage.ApauthData;
import org.ap.summonerwar.storage.ApauthCollection;
import org.ap.summonerwar.storage.UserData;
import org.ap.summonerwar.storage.UserCollection;
import org.ap.web.internal.APWebException;
import org.ap.summonerwar.internal.MailSender;
import org.ap.summonerwar.internal.ETokenType;
import org.ap.common.TimeHelper;
import static com.mongodb.client.model.Filters.*;
import org.ap.summonerwar.bean.RuneBean;
import org.ap.summonerwar.bean.MonsterBean;
import org.ap.summonerwar.bean.ImportBean;
import org.ap.summonerwar.helpers.ImportHelper;

/* This class was auto-generated by the JavaWriter */
@Path("/user")
public class UserServlet extends APServletBase {

	public static final String PATH = "/user";

	@GET
	@Produces({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	@SuppressWarnings("unchecked")
	public Response getUsers(@Context SecurityContext sc) {
		try {
			FindIterable<Document> documents = Mongo.get().collection("user").find();
			List<UserBean> beanList = new ArrayList<UserBean>();
			for (Document document: documents){
				UserBean bean = new UserBean();
				bean.lastImport = (List<Integer>)document.get("lastImport");
				bean.id = document.getString("id");
				bean.username = document.getString("username");
				bean.password = document.getString("password");
				bean.email = document.getString("email");
				beanList.add(bean);
			}
			return Response.status(Status.OK).entity(beanList.toArray(new UserBean[beanList.size()])).build();
			
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@POST
	@Consumes({MediaType.APPLICATION_JSON})
	public Response postUser(@Context SecurityContext sc, UserBean userBean) {
		try {
			ApauthData dataAuth = ApauthCollection.getByUsername(userBean.username);
			UserData dataEntity;
			if(dataAuth != null) {
				if(dataAuth.getRegistered()) {
					throw APWebException.AP_AUTH_REG_001;
				} else {
					UserCollection.deleteByAuthId(dataAuth.id);
					ApauthCollection.delete(dataAuth);
				}
			}
			dataAuth = ApauthCollection.getByEmail(userBean.email);
			if(dataAuth != null) {
				if(dataAuth.getRegistered()) {
					throw APWebException.AP_AUTH_REG_002;
				} else {
					UserCollection.deleteByAuthId(dataAuth.id);
					ApauthCollection.delete(dataAuth);
				}
			}
			
			List<String> roles = new ArrayList<String>();
			roles.add("user");
			roles.add("apauth");
			
			dataAuth = new ApauthData();
			dataAuth.setId(UUIDGenerator.nextId());
			dataAuth.setEntityId(UUIDGenerator.nextId());
			dataAuth.setUsername(userBean.username);
			dataAuth.setPassword(userBean.password);
			dataAuth.setEmail(userBean.email);
			dataAuth.setType("user");
			dataAuth.setRoles(roles);
			dataAuth.setRegistered(Boolean.FALSE);
			dataAuth.setActive(Boolean.TRUE);
			dataAuth.setToken(UUIDGenerator.nextCode());
			dataAuth.setTokenType(ETokenType.REGISTER.name());
			dataAuth.setTokenDateTime(TimeHelper.nowDateTimeIntegers());
			ApauthCollection.create(dataAuth);
			
			dataEntity = new UserData();
			dataEntity.id = dataAuth.entityId;
			dataEntity.authId = dataAuth.id;
			dataEntity.lastImport = userBean.lastImport;
			UserCollection.create(dataEntity);
			
			MailSender.sendRegistrationMail(dataAuth);
			
			return Response.status(Status.CREATED).build();
			
		} catch (MongoWriteException e) {
			return Response.status(Status.FORBIDDEN).build();
		} catch (APWebException e) {
			return sendException(e);
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@GET
	@Path("/{userId}")
	@Produces({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	public Response getUser(@Context SecurityContext sc, @PathParam("userId") final String userId) {
		try {
			UserData data = UserCollection.getById(userId);
			if(data == null) {
				return Response.status(Status.NOT_FOUND).build();
			}
			ApauthData dataAuth = ApauthCollection.getById(data.authId);
			if(dataAuth == null) {
				return Response.status(Status.NOT_FOUND).build();
			}
			
			UserBean bean = new UserBean();
			bean.lastImport = data.getLastImport();
			bean.id = data.getId();
			bean.username = dataAuth.getUsername();
			bean.email = dataAuth.getEmail();
			return Response.status(Status.OK).entity(bean).build();
			
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@PUT
	@Path("/{userId}")
	@Consumes({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	public Response putUser(@Context SecurityContext sc, @PathParam("userId") final String userId, UserBean userBean) {
		try {
			Document document = new Document();
			if(userBean.lastImport != null)
				document.append("lastImport", userBean.lastImport);
			if(userBean.id != null)
				document.append("id", userBean.id);
			if(userBean.username != null)
				document.append("username", userBean.username);
			if(userBean.password != null)
				document.append("password", userBean.password);
			if(userBean.email != null)
				document.append("email", userBean.email);
			Document result = Mongo.get().collection("user").findOneAndUpdate(and(eq("userId", userId)), new Document("$set", document));
			if(result == null)
				return Response.status(Status.NOT_FOUND).build();
			return Response.status(Status.OK).build();
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@DELETE
	@Path("/{userId}")
	@RolesAllowed("user")
	public Response deleteUser(@Context SecurityContext sc, @PathParam("userId") final String userId) {
		try {
			if (UserCollection.deleteById(userId)) {
				return Response.status(Status.OK).build();
			}
			return Response.status(Status.NOT_FOUND).build();
			
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@GET
	@Path("/{userId}/runes")
	@Produces({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	public Response getUserRunes(@Context SecurityContext sc, @PathParam("userId") final String userId) {
		try {
			FindIterable<Document> documents = Mongo.get().collection("rune").find(and(eq("userId", userId)));
			List<RuneBean> beanList = new ArrayList<RuneBean>();
			for (Document document: documents){
				RuneBean bean = new RuneBean();
				bean.lvl = document.getInteger("lvl");
				bean.set = document.getString("set");
				bean.stat4Type = document.getString("stat4Type");
				bean.star = document.getInteger("star");
				bean.stat2Type = document.getString("stat2Type");
				bean.statSub = document.getInteger("statSub");
				bean.statMain = document.getInteger("statMain");
				bean.stat4 = document.getInteger("stat4");
				bean.userId = document.getString("userId");
				bean.stat3Type = document.getString("stat3Type");
				bean.stat2 = document.getInteger("stat2");
				bean.pos = document.getString("pos");
				bean.stat3 = document.getInteger("stat3");
				bean.statSubType = document.getString("statSubType");
				bean.stat1 = document.getInteger("stat1");
				bean.monsterId = document.getString("monsterId");
				bean.stat1Type = document.getString("stat1Type");
				bean.statMainType = document.getString("statMainType");
				bean.id = document.getString("id");
				beanList.add(bean);
			}
			return Response.status(Status.OK).entity(beanList.toArray(new RuneBean[beanList.size()])).build();
			
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@GET
	@Path("/{userId}/monsters")
	@Produces({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	public Response getUserMonsters(@Context SecurityContext sc, @PathParam("userId") final String userId) {
		try {
			FindIterable<Document> documents = Mongo.get().collection("monster").find(and(eq("userId", userId)));
			List<MonsterBean> beanList = new ArrayList<MonsterBean>();
			for (Document document: documents){
				MonsterBean bean = new MonsterBean();
				bean.acc = document.getInteger("acc");
				bean.res = document.getInteger("res");
				bean.lvl = document.getInteger("lvl");
				bean.role = document.getString("role");
				bean.star = document.getInteger("star");
				bean.isAwaked = document.getBoolean("isAwaked");
				bean.def = document.getInteger("def");
				bean.spd = document.getInteger("spd");
				bean.hp = document.getInteger("hp");
				bean.crate = document.getInteger("crate");
				bean.userId = document.getString("userId");
				bean.elemType = document.getString("elemType");
				bean.cdmg = document.getInteger("cdmg");
				bean.name = document.getString("name");
				bean.xp = document.getInteger("xp");
				bean.atk = document.getInteger("atk");
				bean.id = document.getString("id");
				beanList.add(bean);
			}
			return Response.status(Status.OK).entity(beanList.toArray(new MonsterBean[beanList.size()])).build();
			
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

	@POST
	@Path("/import")
	@Consumes({MediaType.APPLICATION_JSON})
	@RolesAllowed("user")
	public Response postUserImport(@Context SecurityContext sc, ImportBean importBean) {
		try {
			Object bean = ImportHelper.postImport(sc, importBean);
			return Response.status(Status.OK).entity(bean).build();
			
		} catch (APWebException e) {
			return sendException(e);
		} catch (Exception e) {
			return Response.status(Status.INTERNAL_SERVER_ERROR).build();
		}
	}

}
